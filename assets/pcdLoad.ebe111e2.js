import{L as B,F as T,a as U,B as H,b as P,I as V,P as k,c as R,V as W,R as N,S as $,d as M,W as G,e as j}from"./three.module.00e15d00.js";import{O as q}from"./OrbitControls.7e68ed9b.js";import{d as D,j as S,q as Z,s as K,o as C,f as L,u as A,J as Y,Z as J,M as X,N as Q,H as ee,_ as O,K as te}from"./index.bce7ea25.js";class ne extends B{constructor(x){super(x),this.littleEndian=!0}load(x,F,z,y){const t=this,p=new T(t.manager);p.setPath(t.path),p.setResponseType("arraybuffer"),p.setRequestHeader(t.requestHeader),p.setWithCredentials(t.withCredentials),p.load(x,function(c){try{F(t.parse(c))}catch(a){y?y(a):console.error(a),t.manager.itemError(x)}},z,y)}parse(x){function F(i,e){const g=i.length,o=new Uint8Array(e);let l=0,n=0,r,f,_;do if(r=i[l++],r<1<<5){if(r++,n+r>e)throw new Error("Output buffer is not large enough");if(l+r>g)throw new Error("Invalid compressed data");do o[n++]=i[l++];while(--r)}else{if(f=r>>5,_=n-((r&31)<<8)-1,l>=g)throw new Error("Invalid compressed data");if(f===7&&(f+=i[l++],l>=g))throw new Error("Invalid compressed data");if(_-=i[l++],n+f+2>e)throw new Error("Output buffer is not large enough");if(_<0)throw new Error("Invalid compressed data");if(_>=n)throw new Error("Invalid compressed data");do o[n++]=o[_++];while(--f+2)}while(l<g);return o}function z(i){const e={},g=i.search(/[\r\n]DATA\s(\S*)\s/i),o=/[\r\n]DATA\s(\S*)\s/i.exec(i.slice(g-1));if(e.data=o[1],e.headerLen=o[0].length+g,e.str=i.slice(0,e.headerLen),e.str=e.str.replace(/\#.*/gi,""),e.version=/VERSION (.*)/i.exec(e.str),e.fields=/FIELDS (.*)/i.exec(e.str),e.size=/SIZE (.*)/i.exec(e.str),e.type=/TYPE (.*)/i.exec(e.str),e.count=/COUNT (.*)/i.exec(e.str),e.width=/WIDTH (.*)/i.exec(e.str),e.height=/HEIGHT (.*)/i.exec(e.str),e.viewpoint=/VIEWPOINT (.*)/i.exec(e.str),e.points=/POINTS (.*)/i.exec(e.str),e.version!==null&&(e.version=parseFloat(e.version[1])),e.fields=e.fields!==null?e.fields[1].split(" "):[],e.type!==null&&(e.type=e.type[1].split(" ")),e.width!==null&&(e.width=parseInt(e.width[1])),e.height!==null&&(e.height=parseInt(e.height[1])),e.viewpoint!==null&&(e.viewpoint=e.viewpoint[1]),e.points!==null&&(e.points=parseInt(e.points[1],10)),e.points===null&&(e.points=e.width*e.height),e.size!==null&&(e.size=e.size[1].split(" ").map(function(n){return parseInt(n,10)})),e.count!==null)e.count=e.count[1].split(" ").map(function(n){return parseInt(n,10)});else{e.count=[];for(let n=0,r=e.fields.length;n<r;n++)e.count.push(1)}e.offset={};let l=0;for(let n=0,r=e.fields.length;n<r;n++)e.data==="ascii"?e.offset[e.fields[n]]=n:(e.offset[e.fields[n]]=l,l+=e.size[n]*e.count[n]);return e.rowSize=l,e}const y=U.decodeText(new Uint8Array(x)),t=z(y),p=[],c=[],a=[],h=[],w=[];if(t.data==="ascii"){const i=t.offset,g=y.slice(t.headerLen).split(`
`);for(let o=0,l=g.length;o<l;o++){if(g[o]==="")continue;const n=g[o].split(" ");if(i.x!==void 0&&(p.push(parseFloat(n[i.x])),p.push(parseFloat(n[i.y])),p.push(parseFloat(n[i.z]))),i.rgb!==void 0){const r=t.fields.findIndex(v=>v==="rgb"),f=t.type[r],_=parseFloat(n[i.rgb]);let s=_;if(f==="F"){const v=new Float32Array(1);v[0]=_,s=new Int32Array(v.buffer)[0]}const d=s>>16&255,u=s>>8&255,I=s>>0&255;a.push(d/255,u/255,I/255)}i.normal_x!==void 0&&(c.push(parseFloat(n[i.normal_x])),c.push(parseFloat(n[i.normal_y])),c.push(parseFloat(n[i.normal_z]))),i.intensity!==void 0&&h.push(parseFloat(n[i.intensity])),i.label!==void 0&&w.push(parseInt(n[i.label]))}}if(t.data==="binary_compressed"){const i=new Uint32Array(x.slice(t.headerLen,t.headerLen+8)),e=i[0],g=i[1],o=F(new Uint8Array(x,t.headerLen+8,e),g),l=new DataView(o.buffer),n=t.offset;for(let r=0;r<t.points;r++){if(n.x!==void 0){const f=t.fields.indexOf("x"),_=t.fields.indexOf("y"),s=t.fields.indexOf("z");p.push(l.getFloat32(t.points*n.x+t.size[f]*r,this.littleEndian)),p.push(l.getFloat32(t.points*n.y+t.size[_]*r,this.littleEndian)),p.push(l.getFloat32(t.points*n.z+t.size[s]*r,this.littleEndian))}if(n.rgb!==void 0){const f=t.fields.indexOf("rgb");a.push(l.getUint8(t.points*n.rgb+t.size[f]*r+2)/255),a.push(l.getUint8(t.points*n.rgb+t.size[f]*r+1)/255),a.push(l.getUint8(t.points*n.rgb+t.size[f]*r+0)/255)}if(n.normal_x!==void 0){const f=t.fields.indexOf("normal_x"),_=t.fields.indexOf("normal_y"),s=t.fields.indexOf("normal_z");c.push(l.getFloat32(t.points*n.normal_x+t.size[f]*r,this.littleEndian)),c.push(l.getFloat32(t.points*n.normal_y+t.size[_]*r,this.littleEndian)),c.push(l.getFloat32(t.points*n.normal_z+t.size[s]*r,this.littleEndian))}if(n.intensity!==void 0){const f=t.fields.indexOf("intensity");h.push(l.getFloat32(t.points*n.intensity+t.size[f]*r,this.littleEndian))}if(n.label!==void 0){const f=t.fields.indexOf("label");w.push(l.getInt32(t.points*n.label+t.size[f]*r,this.littleEndian))}}}if(t.data==="binary"){const i=new DataView(x,t.headerLen),e=t.offset;for(let g=0,o=0;g<t.points;g++,o+=t.rowSize)e.x!==void 0&&(p.push(i.getFloat32(o+e.x,this.littleEndian)),p.push(i.getFloat32(o+e.y,this.littleEndian)),p.push(i.getFloat32(o+e.z,this.littleEndian))),e.rgb!==void 0&&(a.push(i.getUint8(o+e.rgb+2)/255),a.push(i.getUint8(o+e.rgb+1)/255),a.push(i.getUint8(o+e.rgb+0)/255)),e.normal_x!==void 0&&(c.push(i.getFloat32(o+e.normal_x,this.littleEndian)),c.push(i.getFloat32(o+e.normal_y,this.littleEndian)),c.push(i.getFloat32(o+e.normal_z,this.littleEndian))),e.intensity!==void 0&&h.push(i.getFloat32(o+e.intensity,this.littleEndian)),e.label!==void 0&&w.push(i.getInt32(o+e.label,this.littleEndian))}const m=new H;p.length>0&&m.setAttribute("position",new P(p,3)),c.length>0&&m.setAttribute("normal",new P(c,3)),a.length>0&&m.setAttribute("color",new P(a,3)),h.length>0&&m.setAttribute("intensity",new P(h,1)),w.length>0&&m.setAttribute("label",new V(w,1)),m.computeBoundingSphere();const b=new k({size:.005});return a.length>0&&(b.vertexColors=!0),new R(m,b)}}const ie=E=>(X("data-v-4aae1c7e"),E=E(),Q(),E),se={class:"threeContainer"},oe=ie(()=>ee("div",{id:"threePCD",style:{width:"100%",height:"100%"}},null,-1)),re={key:0,class:"pcdPosInfo"},le=D({__name:"ThreePCD",props:{pcdSrc:String},setup(E){const x=E;let F=S(""),z=S(!1),y,t=new W,p=new N,c,a,h,w,m=[-30,2,-1];const b={center:[-.41,-.57,-.52],position:[-.02,-.47,-.88],target:[0,0,0]};Z(()=>{i(),o()}),K(()=>{l()});function i(){var d,u;const s=document.getElementById("threePCD");if(s){const I=(d=s.clientWidth)!=null?d:0,v=(u=s.clientHeight)!=null?u:0;c=new $,h=new M(30,window.innerWidth/window.innerHeight,.01,1e4),h.up.set(0,0,1),c.add(h),a=new G({antialias:!0}),a.setPixelRatio(window.devicePixelRatio),a.setSize(I,v),w=new q(h,a.domElement),w.addEventListener("change",e),w.target=new j(0,0,0),w.enableDamping=!0,w.dampingFactor=.1,w.keyPanSpeed=5,w.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowBottom"},w.listenToKeyEvents(window),s.appendChild(a.domElement),g(),window.addEventListener("resize",n),window.addEventListener("keypress",r),s.addEventListener("click",f)}}function e(){let s="";a.render(c,h);const d=c.children;d.length>0&&d.map(u=>{u.type==="Points"&&(s+=`center: (${u.position.x.toFixed(2)},${u.position.y.toFixed(2)},${u.position.z.toFixed(2)}); `)}),s+=`camera: (${h.position.x.toFixed(2)}, ${h.position.y.toFixed(2)}, ${h.position.z.toFixed(2)})`,F.value=s,z.value=!0}function g(){x.pcdSrc?new ne().load(x.pcdSrc,d=>{d.position.set(b.center[0],b.center[1],b.center[2]),d.name="mypcd",c.add(d),_("frontView")},function(d){console.log(d.loaded/d.total*100+"% loaded")},function(d){console.log(d)}):console.log("no pcd file scr")}function o(){y=requestAnimationFrame(o),w.update()}function l(){var d;console.log("\u9500\u6BC1\u6A21\u578B");const s=document.getElementById("threePCDthreePCD");try{if(s){window.cancelAnimationFrame(y),c.clear(),a.dispose(),a.forceContextLoss();const u=a.domElement.getContext("webgl");u&&((d=u.getExtension("WEBGL_lose_context"))==null||d.loseContext()),s.innerHTML="",console.log("\u9500\u6BC1\u6210\u529F")}}catch(u){console.log(u),console.log("\u9500\u6BC1\u5931\u8D25")}}function n(){const s=document.getElementById("threePCD"),d=(s==null?void 0:s.clientWidth)||0,u=(s==null?void 0:s.clientHeight)||0;h.aspect=d/u,h.updateProjectionMatrix(),a.setSize(d,u),e()}function r(){console.log("keyboard")}function f(s){if(s.ctrlKey){const d=c.getObjectByName("mypcd");if(!d)return;t.x=s.offsetX/a.domElement.clientWidth*2-1,t.y=-(s.offsetY/a.domElement.clientHeight*2)+1,p.setFromCamera(t,h);const u=p.intersectObjects(c.children);if(u.length){const I=u[0];m[0]=m[0]-I.point.x,m[1]=m[1]-I.point.y,m[2]=m[2]-I.point.z,d.position.set(m[0],m[1],m[2]),e(),console.log(I.point)}}}function _(s){switch(s){case"frontView":h.position.set(b.position[0],b.position[1],b.position[2]);break}w.update(),w.saveState(),e()}return(s,d)=>(C(),L("div",se,[oe,A(z)?(C(),L("div",re,Y(A(F)),1)):J("",!0)]))}});const ae=O(le,[["__scopeId","data-v-4aae1c7e"]]),de={class:"pcdLoad"},ce=D({__name:"pcdLoad",setup(E){const x=location.origin+"/model/pcd/Zaghetto.pcd";return(F,z)=>(C(),L("div",de,[te(ae,{pcdSrc:x})]))}});const he=O(ce,[["__scopeId","data-v-836560e5"]]);export{he as default};
